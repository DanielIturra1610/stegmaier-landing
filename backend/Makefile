# Stegmaier LMS Backend - Makefile
# Go commands for development and deployment

.PHONY: help build run test clean dev docker-build docker-up docker-down migrate-up migrate-down lint fmt vet

# Variables
BINARY_NAME=stegmaier-api
GO_FILES=$(shell find . -name '*.go' -type f -not -path "./vendor/*")
MAIN_PATH=./cmd/api
BUILD_DIR=./bin

# Default target
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘          Stegmaier LMS Backend - Available Commands           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  make dev              - Run server with hot reload (air)"
	@echo "  make run              - Run server without hot reload"
	@echo "  make build            - Build binary for current OS"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test             - Run all tests"
	@echo "  make test-unit        - Run unit tests only"
	@echo "  make test-integration - Run integration tests"
	@echo "  make test-e2e         - Run E2E tests"
	@echo "  make test-coverage    - Run tests with coverage report"
	@echo "  make test-verbose     - Run tests with verbose output"
	@echo ""
	@echo "ğŸ” Code Quality:"
	@echo "  make lint             - Run golangci-lint"
	@echo "  make fmt              - Format code with gofmt"
	@echo "  make vet              - Run go vet"
	@echo "  make tidy             - Run go mod tidy"
	@echo ""
	@echo "ğŸ—„ï¸  Database:"
	@echo "  make migrate-up       - Run all migrations"
	@echo "  make migrate-down     - Rollback one migration"
	@echo "  make migrate-create   - Create new migration (name=migration_name)"
	@echo "  make db-reset         - Reset database (drop + migrate)"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  make docker-build     - Build Docker image"
	@echo "  make docker-up        - Start Docker containers"
	@echo "  make docker-down      - Stop Docker containers"
	@echo "  make docker-logs      - View Docker logs"
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@echo "  make clean            - Remove build artifacts"
	@echo "  make clean-all        - Remove build artifacts and dependencies"
	@echo ""

# Build commands
build:
	@echo "ğŸ”¨ Building $(BINARY_NAME)..."
	@go build -o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PATH)
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME)"

build-linux:
	@echo "ğŸ”¨ Building $(BINARY_NAME) for Linux..."
	@GOOS=linux GOARCH=amd64 go build -o $(BUILD_DIR)/$(BINARY_NAME)-linux $(MAIN_PATH)
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME)-linux"

build-windows:
	@echo "ğŸ”¨ Building $(BINARY_NAME) for Windows..."
	@GOOS=windows GOARCH=amd64 go build -o $(BUILD_DIR)/$(BINARY_NAME).exe $(MAIN_PATH)
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME).exe"

build-mac:
	@echo "ğŸ”¨ Building $(BINARY_NAME) for macOS..."
	@GOOS=darwin GOARCH=amd64 go build -o $(BUILD_DIR)/$(BINARY_NAME)-mac $(MAIN_PATH)
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME)-mac"

# Run commands
run: build
	@echo "ğŸš€ Running $(BINARY_NAME)..."
	@$(BUILD_DIR)/$(BINARY_NAME)

dev:
	@if command -v air > /dev/null; then \
		echo "ğŸ”¥ Starting development server with hot reload..."; \
		air; \
	else \
		echo "âš ï¸  'air' not found. Install it with: go install github.com/cosmtrek/air@latest"; \
		echo "ğŸ“ Running without hot reload..."; \
		go run $(MAIN_PATH); \
	fi

# Test commands
test:
	@echo "ğŸ§ª Running all tests..."
	@go test -v ./...

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	@go test -v -short ./...

test-integration:
	@echo "ğŸ§ª Running integration tests..."
	@go test -v -run Integration ./tests/integration/...

test-e2e:
	@echo "ğŸ§ª Running E2E tests..."
	@go test -v ./tests/e2e/...

test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	@go test -v -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

test-verbose:
	@echo "ğŸ§ª Running tests with verbose output..."
	@go test -v -count=1 ./...

# Code quality commands
lint:
	@if command -v golangci-lint > /dev/null; then \
		echo "ğŸ” Running golangci-lint..."; \
		golangci-lint run ./...; \
	else \
		echo "âš ï¸  'golangci-lint' not found. Install it from: https://golangci-lint.run/usage/install/"; \
	fi

fmt:
	@echo "ğŸ¨ Formatting code..."
	@gofmt -s -w $(GO_FILES)
	@echo "âœ… Code formatted"

vet:
	@echo "ğŸ” Running go vet..."
	@go vet ./...
	@echo "âœ… Vet check passed"

tidy:
	@echo "ğŸ“¦ Tidying go modules..."
	@go mod tidy
	@echo "âœ… Dependencies tidied"

# Database commands
migrate-up:
	@echo "â¬†ï¸  Running migrations..."
	@go run $(MAIN_PATH) migrate up
	@echo "âœ… Migrations applied"

migrate-down:
	@echo "â¬‡ï¸  Rolling back migration..."
	@go run $(MAIN_PATH) migrate down
	@echo "âœ… Migration rolled back"

migrate-create:
	@if [ -z "$(name)" ]; then \
		echo "âŒ Error: Please provide a migration name"; \
		echo "Usage: make migrate-create name=create_users_table"; \
		exit 1; \
	fi
	@echo "ğŸ“ Creating migration: $(name)..."
	@migrate create -ext sql -dir migrations/control -seq $(name)
	@echo "âœ… Migration created in migrations/control/"

db-reset:
	@echo "ğŸ”„ Resetting database..."
	@echo "âš ï¸  This will drop all data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@go run $(MAIN_PATH) migrate down
	@go run $(MAIN_PATH) migrate up
	@echo "âœ… Database reset complete"

# Docker commands
docker-build:
	@echo "ğŸ³ Building Docker image..."
	@docker build -t stegmaier-backend:latest .
	@echo "âœ… Docker image built"

docker-up:
	@echo "ğŸ³ Starting Docker containers..."
	@docker-compose up -d
	@echo "âœ… Containers started"

docker-down:
	@echo "ğŸ³ Stopping Docker containers..."
	@docker-compose down
	@echo "âœ… Containers stopped"

docker-logs:
	@echo "ğŸ“‹ Showing Docker logs..."
	@docker-compose logs -f

docker-restart: docker-down docker-up

# Cleanup commands
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)
	@rm -f coverage.out coverage.html
	@echo "âœ… Clean complete"

clean-all: clean
	@echo "ğŸ§¹ Removing dependencies..."
	@rm -rf vendor/
	@go clean -modcache
	@echo "âœ… Deep clean complete"

# Install development dependencies
install-deps:
	@echo "ğŸ“¦ Installing development dependencies..."
	@go install github.com/cosmtrek/air@latest
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/golang-migrate/migrate/v4/cmd/migrate@latest
	@echo "âœ… Development dependencies installed"

# Generate code
generate:
	@echo "âš™ï¸  Running go generate..."
	@go generate ./...
	@echo "âœ… Code generation complete"

# Security scan
security:
	@if command -v gosec > /dev/null; then \
		echo "ğŸ”’ Running security scan..."; \
		gosec ./...; \
	else \
		echo "âš ï¸  'gosec' not found. Install it with: go install github.com/securego/gosec/v2/cmd/gosec@latest"; \
	fi

# Dependency check
deps-check:
	@echo "ğŸ“¦ Checking for outdated dependencies..."
	@go list -u -m all

# Full check before commit
pre-commit: fmt vet lint test
	@echo "âœ… All pre-commit checks passed!"

# Production build
build-prod:
	@echo "ğŸ­ Building production binary..."
	@CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
		-ldflags="-w -s -X main.Version=$(shell git describe --tags --always --dirty) -X main.BuildTime=$(shell date -u +%Y-%m-%dT%H:%M:%S)" \
		-o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PATH)
	@echo "âœ… Production build complete"

.DEFAULT_GOAL := help
